#!/usr/bin/env bash

DIR=$( cd "$(dirname "${BASH_SOURCE[0]}")" || exit ; pwd -P )
LOG_FILE="${DIR}/build.log"
POOL="~/.runc"

# Check if the image exists
IMAGE=$1
VALID=1
for i in $(cd ${DIR} && ls -d */ | cut -f1 -d'/'); do
	if [ "${IMAGE}" == "${i}" ]; then
		VALID=0
	fi
done

if [ ${VALID} -eq 1 ]; then
	echo "The image ${IMAGE} doesn't exist"
	exit 1
fi

# Generate the new container's name
CONTAINER="${IMAGE}-$(date +%s%N)"
FOLDER=${POOL}/${CONTAINER}

# Copy image to pool
mkdir -p ${FOLDER}
cp -r ${DIR}/${IMAGE}/rootfs ${FOLDER}/rootfs
cp ${DIR}/${IMAGE}/config.json ${FOLDER}/config.json

# Mount image base in container mount point
bindfs -p 555 --no-allow-other ${DIR}/${IMAGE}/ro-rootfs ${FOLDER}/rootfs/mnt
if [ $(echo $?) -eq 1 ]; then
	rm -rf ${FOLDER}
	echo "The container couldn't be created"
	exit 1
fi

# Display the created container name
echo ${CONTAINER}
